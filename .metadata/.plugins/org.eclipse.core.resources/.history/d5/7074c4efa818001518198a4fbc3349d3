package com.ucab.javachat.Cliente.controller;

import com.ucab.javachat.Cliente.model.Cliente;
import com.ucab.javachat.Cliente.view.VentRecuperarContraseña;
import com.ucab.javachat.Cliente.model.Criptologia;

import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.File;
import java.io.IOException;

import javax.swing.JFileChooser;
import javax.swing.JOptionPane;
import javax.swing.filechooser.FileNameExtensionFilter;

public class ControladorRecuperarContraseña implements ActionListener{

	private VentRecuperarContraseña vista;
	private boolean flag = true;

	public ControladorRecuperarContraseña (VentRecuperarContraseña vista){
		this.vista = vista;
		this.vista.frameRecuperarContraseña.setVisible(true);
		this.vista.btnEnviar.addActionListener(this);
		this.vista.btnSeleccionar.addActionListener(this);
	}

		
/*Primero se codifica, despues se manda al servidor y se ve si esta registrado. 
 * Si el usuario esta registrado se envia el correo. */
	
	public void actionPerformed(ActionEvent e) {	//metodo para enviar la informacion
		String correo = null;
		File imagen = null;
		
		if (vista.btnSeleccionar == e.getSource()){
			JFileChooser chooser = new JFileChooser();
			FileNameExtensionFilter filtro = new FileNameExtensionFilter(".jpg", "jpg");
	        chooser.setFileFilter(filtro);
	        chooser.setFileSelectionMode(JFileChooser.FILES_ONLY);
			File archivos = new File ("/home/user");
			chooser.setCurrentDirectory(archivos);
			chooser.setDialogTitle("Seleccione una foto.");
			//Elegiremos archivos del directorio;
			chooser.setAcceptAllFileFilterUsed(false);
			//Si seleccionamos algún archivo retornaremos su directorio
			if (chooser.showOpenDialog(vista.frameRecuperarContraseña) == JFileChooser.APPROVE_OPTION) {
				imagen = chooser.getSelectedFile();
				vista.campoImagen.setText(imagen.getName());
			}
			else flag = false;
		}
		
		if (vista.btnEnviar == e.getSource()){
			if (vista.textField.getText().equals(""))
				flag = false;
			else
				correo = Criptologia.encriptar(vista.textField.getText());
			if (true != (vista.campoImagen.getText().contains(".jpg")))
				flag = false;
			
		}
		if (flag){
			try {
				Cliente cliente = new Cliente();
				if(cliente.conexion(correo,imagen)) {
					vista.frameRecuperarContraseña.setVisible(false);
					 JOptionPane.showMessageDialog(null, "Se ha enviado un correo con su contraseña", "Recuperación", JOptionPane.INFORMATION_MESSAGE);
				} else {
					 JOptionPane.showMessageDialog(null, "Ha ocurrido un error", "Problema de conexión", JOptionPane.INFORMATION_MESSAGE);
				}
			} 
			catch (IOException e1) {
				e1.printStackTrace();
			}
		}
	}
		

}